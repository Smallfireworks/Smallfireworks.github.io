document.addEventListener("DOMContentLoaded",()=>{"use strict";const e=document.getElementById("teacher-search-app"),t=e.dataset.baseUrl,a=60,s=20,c=260,n=2;let o,l,r,i=new Map,d=0,p=-1,u=new Map;const h=document.getElementById("searchInput"),m=document.getElementById("clearSearch"),g=document.getElementById("departmentInput"),f=document.getElementById("departmentDropdown"),y=document.getElementById("teacher-list"),b=document.getElementById("modal-container"),v=document.getElementById("back-to-top");function w(e,t){let a;return function(...s){clearTimeout(a),a=setTimeout((()=>e.apply(this,s)),t)}}async function E(e,t=n){for(let a=0;a<=t;a++)try{const t=await fetch(e,{cache:"no-cache"});if(!t.ok)throw new Error("HTTP "+t.status);return await t.json()}catch(s){if(a===t)throw s;await new Promise((e=>setTimeout(e,150*(a+1))))}}function L(e,t){if(!t)return e;const a=new RegExp(`(${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return e.replace(a,"<strong>$1</strong>")}function k(e,t){return`<div class="comment-controls"><span class="comment-count-display">å…± ${e.m.length} æ¡</span><div class="comment-sort-buttons"><button class="sort-btn ${"popularity"===t?"active":""}" data-sort="popularity">æŒ‰äººæ°”</button><button class="sort-btn ${"time"===t?"active":""}" data-sort="time">æŒ‰æ—¶é—´</button></div></div><div class="comments-list">${S(e.m,t)}</div>`}function S(e,t){const a=[...e].sort(((e,a)=>"time"===t?(a.t||"").localeCompare(e.t||""):(a.p||0)-(e.p||0)));return a.map((e=>`<div class="comment"><div class="comment-body" style="white-space: pre-wrap;">${(e.c||"").replace(/\\n/g,"\n")}</div><div class="comment-meta"><span>${e.t||""}</span><span class="comment-likes"><span class="like">ğŸ‘ ${e.u||0}</span> | <span class="dislike">ğŸ‘ ${e.d||0}</span></span></div></div>`)).join("")}function A(){const e=b.querySelector(".modal-overlay");e&&(e.classList.remove("visible"),e.querySelector(".modal-content").style.transform="scale(0.95)"),document.body.classList.remove("modal-open"),b.setAttribute("aria-hidden","true"),setTimeout((()=>{b.classList.add("modal-hidden"),b.innerHTML=""}),300)}function T(){if(!l)return;const e=(g.value||"").toLowerCase(),t=l.d.filter((t=>t.toLowerCase().includes(e)));0===t.length?(f.classList.add("hidden"),p=-1):(f.innerHTML=t.map(((e,t)=>`<div class="dept-dropdown-item ${0===t?"active":""}" role="option" data-value="${e}">${e}</div>`)).join(""),p=0,f.classList.remove("hidden"))}function H(e){const t=Array.from(f.querySelectorAll(".dept-dropdown-item"));0!==t.length&&(t[p].classList.remove("active"),p=(p+e+t.length)%t.length,t[p].classList.add("active"),t[p].scrollIntoView({block:"nearest"}))}(async()=>{y.innerHTML=((e=`\n      <div class="skeleton-card" aria-hidden="true">\n        <div class="teacher-header"><div class="skeleton-line title shimmer"></div><div class="skeleton-line dept shimmer"></div></div>\n        <div class="skeleton-line text shimmer"></div><div class="skeleton-line w-75 shimmer"></div>\n      </div>`)=>Array(3).fill(e).join(""))(),await async function(){try{const[e,t,a]=await Promise.all([E(`${t}index.json`),E(`${t}metadata.json`),E(`${t}courses.json`)]);o=e,l=t,r=a}catch(e){return console.error("Error loading initial data:",e),void(y.innerHTML='<p class="info-message">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•ã€‚</p>')}}(),o&&(y.innerHTML='<p class="initial-message">è¯·è¾“å…¥æ•™å¸ˆå§“åã€æ‹¼éŸ³æˆ–é€‰æ‹©å­¦é™¢ä»¥å¼€å§‹æŸ¥è¯¢ã€‚</p>')})();const C=w((async function(){const e=++d,n=(h.value||"").toLowerCase().trim(),p=(g.value||"").toLowerCase().trim();if(m.classList.toggle("hidden",0===h.value.length),!o)return""===n&&""===p?(y.innerHTML='<p class="initial-message">è¯·è¾“å…¥æ•™å¸ˆå§“åã€æ‹¼éŸ³æˆ–é€‰æ‹©å­¦é™¢ä»¥å¼€å§‹æŸ¥è¯¢ã€‚</p>',void 0):void 0;y.innerHTML=((e=`\n      <div class="skeleton-card" aria-hidden="true">\n        <div class="teacher-header"><div class="skeleton-line title shimmer"></div><div class="skeleton-line dept shimmer"></div></div>\n        <div class="skeleton-line text shimmer"></div><div class="skeleton-line w-75 shimmer"></div>\n      </div>`)=>Array(4).fill(e).join(""))();const u=o.filter((e=>(!n||e.s&&e.s.includes(n))&&(!p||e.d&&e.d.toLowerCase().includes(p))));if(e!==d)return;if(0===u.length)return y.innerHTML='<p class="info-message">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è€å¸ˆã€‚</p>',void 0;const v=u.slice(0,a),w=new Set(v.map((e=>e.c)));try{await Promise.all(Array.from(w).map((async function(e){if(i.has(e))return;const a=`${t}teachers_${e}.json`;try{const t=await E(a);i.set(e,t)}catch(t){throw console.error(`Error loading chunk ${e}:`,t),t}})))}catch(t){return e===d&&(y.innerHTML='<p class="info-message">åŠ è½½æ•™å¸ˆæ•°æ®æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•ã€‚</p>'),void 0}if(e!==d)return;y.innerHTML="";let b=0;!function t(){if(e!==d)return;const c=v.slice(b,b+s),o=c.map((e=>{const t=i.get(e.c)?.find((t=>t.id===e.id));return t?function(e,t){let a,s;const c=Array.isArray(e.g)&&e.g.length>0,o=Array.isArray(e.m)&&e.m.length>0,i=t?L(e.n,t):e.n;let d=`<div class="teacher-card" role="article" aria-labelledby="teacher-name-${e.id}"><div class="teacher-header"><span id="teacher-name-${e.id}" class="teacher-name">${i}</span><span class="teacher-dept">${e.d||""}</span></div><div class="teacher-stats"><span><b>è¯„åˆ†:</b> ${(parseFloat(e.r)||0).toFixed(2)} (${e.rc}äºº)</span><span><b>çƒ­åº¦:</b> ${e.h}</span></div>`;return c&&(d+=`<button type="button" class="collapsible" aria-expanded="false" aria-controls="gpa-${e.id}" data-cid="${e.id}">è¯¾ç¨‹GPAä¿¡æ¯ (${e.g.length})</button><div class="collapsible-content" id="gpa-${e.id}"><div class="content-inner">${(a=`<table class="gpa-table" aria-label="è¯¾ç¨‹GPA"><thead><tr><th>è¯¾ç¨‹å</th><th>å¹³å‡ç»©ç‚¹Â±æ ‡å‡†å·®</th><th>é€‰è¯¾äººæ•°</th></tr></thead><tbody>${e.g.map((e=>`<tr><td><a href="#" class="course-link" data-course-name="${e[0]}" data-teacher-name="${t.n}">${e[0]}</a></td><td>${(parseFloat(e[1])||0).toFixed(2)} Â± ${(parseFloat(e[3])||0).toFixed(2)}</td><td>${0===e[2]?"500+":e[2]}</td></tr>`)).join("")}</tbody></table>`,a)}</div></div>`),o&&(d+=`<button type="button" class="collapsible" aria-expanded="false" aria-controls="comments-${e.id}" data-cid="${e.id}">å­¦ç”Ÿè¯„ä»· (${e.m.length})</button><div class="collapsible-content" id="comments-${e.id}" data-teacher-id="${e.id}"><div class="content-inner">${k(e,(null===(s=u.get(e.id))?void 0:s)||"popularity")}</div></div>`),!c&&!o&&(d+='<p style="text-align:center;color:#888;padding:15px 0;">æš‚æ— è¯¾ç¨‹GPAæˆ–å­¦ç”Ÿè¯„ä»·æ•°æ®</p>'),d+="</div>",d}(t,n):""})).join("");y.insertAdjacentHTML("beforeend",o),b+=s,b<v.length?requestIdleCallback(t,{timeout:200}):u.length>a&&y.insertAdjacentHTML("beforeend",`<p class="info-message">ç»“æœè¿‡å¤šï¼Œä»…æ˜¾ç¤ºå‰ ${a} æ¡ï¼ˆå…± ${u.length} æ¡ï¼‰ã€‚</p>`)}()}),c);h.addEventListener("input",C),g.addEventListener("input",(()=>{T(),C()})),g.addEventListener("focus",T),m.addEventListener("click",(()=>{h.value="",h.focus(),C()})),document.addEventListener("click",(e=>{g.contains(e.target)||f.contains(e.target)||f.classList.add("hidden"),e.target.classList.contains("dept-dropdown-item")&&(g.value=e.target.dataset.value,f.classList.add("hidden"),g.focus(),C())})),g.addEventListener("keydown",(e=>{if(f.classList.contains("hidden"))return;"ArrowDown"===e.key?(e.preventDefault(),H(1)):"ArrowUp"===e.key?(e.preventDefault(),H(-1)):"Enter"===e.key?(()=>{const e=f.querySelector(".dept-dropdown-item.active");e&&(g.value=e.dataset.value,f.classList.add("hidden"),C())})():"Escape"===e.key&&f.classList.add("hidden")})),y.addEventListener("click",(e=>{const t=e.target;if(t.classList.contains("collapsible"))t.classList.toggle("active"),t.setAttribute("aria-expanded",!!t.classList.contains("active")),t.nextElementSibling.style.maxHeight=t.classList.contains("active")?t.nextElementSibling.scrollHeight+"px":null;else if(t.matches(".course-link, .course-link *")){e.preventDefault();const e=t.closest(".course-link");!function(e,t){const a=r[e];if(!a)return;const s=`modal-title-${e.replace(/\W/g,"-")}`,c=[...a].sort(((e,t)=>(parseFloat(t.g)||0)-(parseFloat(e.g)||0))).map((a=>`<tr class="${a.t===t?"highlight-row":""}"><td>${a.t}</td><td>${(parseFloat(a.g)||0).toFixed(2)} Â± ${(parseFloat(a.s)||0).toFixed(2)}</td><td>${0===a.n?"500+":a.n}</td></tr>`)).join("");b.innerHTML=`<div class="modal-overlay visible" role="dialog" aria-modal="true" aria-labelledby="${s}"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" id="${s}">${e}</h2><button class="modal-close" aria-label="å…³é—­">Ã—</button></div><div class="table-container"><table class="gpa-table"><thead><tr><th>è€å¸ˆå§“å</th><th>å¹³å‡ç»©ç‚¹Â±æ ‡å‡†å·®</th><th>äººæ•°</th></tr></thead><tbody>${c}</tbody></table></div></div></div>`,b.classList.remove("modal-hidden"),b.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open"),b.querySelector(".modal-close").focus()}(e.dataset.courseName,e.dataset.teacherName)}else if(t.matches(".sort-btn")&&!t.classList.contains("active")){e.preventDefault();const a=t.dataset.sort,s=t.closest(".collapsible-content"),c=parseInt(s.dataset.teacherId,10),n=o.find((e=>e.id===c));if(!n)return;const l=i.get(n.c)?.find((e=>e.id===c));if(!l)return;const r=s.querySelector(".comments-list"),d=s.querySelectorAll(".sort-btn");r.innerHTML=S(l.m,a),d.forEach((e=>e.classList.remove("active"))),t.classList.add("active"),u.set(c,a),s.style.maxHeight&&(s.style.maxHeight=s.scrollHeight+"px")}})),b.addEventListener("click",(e=>{e.target.matches(".modal-overlay, .modal-close, .modal-close *")&&A()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&!b.classList.contains("modal-hidden")&&A()})),window.addEventListener("scroll",(()=>{v.classList.toggle("visible",window.scrollY>300)}),{passive:!0}),v.addEventListener("click",(()=>{window.scrollTo({top:0,behavior:"smooth"})}))});